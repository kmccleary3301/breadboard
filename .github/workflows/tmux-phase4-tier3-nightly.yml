name: tmux-phase4-tier3-nightly

on:
  schedule:
    - cron: "40 8 * * *"
  workflow_dispatch:

jobs:
  phase4-tier3-nightly-warn:
    name: phase4 tier3 nightly (provider+stress, warn-only)
    runs-on: ubuntu-latest
    continue-on-error: true
    env:
      BREADBOARD_PHASE4_REPLAY_LOG_ROOT: ${{ github.workspace }}/docs_tmp/tmux_captures/targets_logs
      TMUX_SOCKET_NAME: bbcap_phase4_tier3_nightly
      RUN_PROVIDER_LANES: "0"
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: requirements.txt

      - name: Install engine dependencies
        run: |
          python -m pip install -r requirements.txt
          python -m pip install pillow wcwidth

      - name: Validate tmux scenario action alias parity
        run: |
          python scripts/validate_tmux_scenario_action_aliases.py \
            --repo-root "$GITHUB_WORKSPACE" \
            --output-json "$GITHUB_WORKSPACE/docs_tmp/tmux_captures/tmux_action_alias_parity_phase4_tier3_nightly.json"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: tui_skeleton/package-lock.json

      - name: Install and build TUI dist
        working-directory: tui_skeleton
        run: |
          npm ci
          npm run build

      - name: Start deterministic stress replay targets
        env:
          RAY_SCE_LOCAL_MODE: "1"
        run: |
          bash scripts/start_tmux_phase4_replay_target.sh --session breadboard_test_ci_phase4_resize_storm --tmux-socket "$TMUX_SOCKET_NAME" --cols 160 --rows 45 --port 9131 --scrollback-mode scrollback --landing-always 1 --use-dist
          bash scripts/start_tmux_phase4_replay_target.sh --session breadboard_test_ci_phase4_concurrency --tmux-socket "$TMUX_SOCKET_NAME" --cols 160 --rows 45 --port 9132 --scrollback-mode scrollback --landing-always 1 --use-dist

      - name: Run tier3 scenarios (warn-only)
        run: |
          set +e
          provider_rc=0
          stress_rc=0
          provider_codex_skip_reason=""
          provider_claude_skip_reason=""

          run_scenario() {
            local target="$1"
            local scenario="$2"
            local actions="$3"
            local label="$4"
            local duration="${5:-60}"
            python scripts/run_tmux_capture_scenario.py \
              --target "$target" \
              --tmux-socket "$TMUX_SOCKET_NAME" \
              --scenario "$scenario" \
              --actions "$actions" \
              --out-root "$GITHUB_WORKSPACE/docs_tmp/tmux_captures/scenarios" \
              --duration "$duration" \
              --interval 0.4 \
              --capture-mode fullpane \
              --tail-lines 120 \
              --final-tail-lines 0 \
              --fullpane-start-markers "BreadBoard v,No conversation yet" \
              --fullpane-max-lines 0 \
              --fullpane-render-max-rows 0 \
              --render-profile phase4_locked_v1 \
              --settle-ms 140 \
              --settle-attempts 5 \
              --session-prefix-guard breadboard_test_ \
              --protected-sessions bb_tui_codex_dev,bb_engine_codex_dev,bb_atp \
              --capture-label "$label"
            return $?
          }

          find_latest_run_dir() {
            local base="$1"
            local manifest
            manifest="$(find "$base" -name scenario_manifest.json -print 2>/dev/null | sort | tail -n1 || true)"
            if [[ -z "$manifest" ]]; then
              echo ""
              return 0
            fi
            dirname "$manifest"
          }

          run_scenario \
            "breadboard_test_ci_phase4_resize_storm:0.0" \
            "phase4_replay/resize_storm_overlay_v1" \
            "$GITHUB_WORKSPACE/config/tmux_scenario_actions/nightly_stress/resize_storm_overlay_v1.json" \
            "phase4_resize_storm_overlay_v1" \
            70
          if [[ $? -ne 0 ]]; then
            stress_rc=1
          fi

          run_scenario \
            "breadboard_test_ci_phase4_concurrency:0.0" \
            "phase4_replay/subagents_concurrency_20_v1" \
            "$GITHUB_WORKSPACE/config/tmux_scenario_actions/nightly_stress/subagents_concurrency_20_v1.json" \
            "phase4_subagents_concurrency_20_v1" \
            70
          if [[ $? -ne 0 ]]; then
            stress_rc=1
          fi

          if [[ "${RUN_PROVIDER_LANES:-0}" == "1" ]]; then
            if ! command -v codex >/dev/null 2>&1; then
              provider_codex_skip_reason="tool_unavailable"
            else
              bash scripts/start_tmux_repl.sh --cli codex --session breadboard_test_provider_codex --workspace "$GITHUB_WORKSPACE" --cols 160 --rows 45 >/dev/null 2>&1
              if [[ $? -ne 0 ]]; then
                provider_rc=1
                provider_codex_skip_reason="start_failed"
              else
                run_scenario \
                  "breadboard_test_provider_codex:0.0" \
                  "nightly_provider/codex_e2e_compact_semantic_v1" \
                  "$GITHUB_WORKSPACE/config/tmux_scenario_actions/nightly_provider/codex_e2e_compact_semantic_v1.json" \
                  "provider_codex_compact_semantic_v1" \
                  90
                if [[ $? -ne 0 ]]; then
                  provider_rc=1
                  provider_codex_skip_reason="auth_or_startup_failure"
                fi
              fi
            fi
            if ! command -v claude >/dev/null 2>&1; then
              provider_claude_skip_reason="tool_unavailable"
            else
              bash scripts/start_tmux_repl.sh --cli claude --session breadboard_test_provider_claude --workspace "$GITHUB_WORKSPACE" --cols 160 --rows 45 >/dev/null 2>&1
              if [[ $? -ne 0 ]]; then
                provider_rc=1
                provider_claude_skip_reason="start_failed"
              else
                run_scenario \
                  "breadboard_test_provider_claude:0.0" \
                  "nightly_provider/claude_e2e_compact_semantic_v1" \
                  "$GITHUB_WORKSPACE/config/tmux_scenario_actions/nightly_provider/claude_e2e_compact_semantic_v1.json" \
                  "provider_claude_compact_semantic_v1" \
                  90
                if [[ $? -ne 0 ]]; then
                  provider_rc=1
                  provider_claude_skip_reason="auth_or_startup_failure"
                fi
              fi
            fi
          else
            provider_codex_skip_reason="provider_lanes_disabled"
            provider_claude_skip_reason="provider_lanes_disabled"
          fi

          RESIZE_RUN_DIR="$(find_latest_run_dir "$GITHUB_WORKSPACE/docs_tmp/tmux_captures/scenarios/phase4_replay/resize_storm_overlay_v1")"
          CONCURRENCY_RUN_DIR="$(find_latest_run_dir "$GITHUB_WORKSPACE/docs_tmp/tmux_captures/scenarios/phase4_replay/subagents_concurrency_20_v1")"
          PROVIDER_CODEX_RUN_DIR="$(find_latest_run_dir "$GITHUB_WORKSPACE/docs_tmp/tmux_captures/scenarios/nightly_provider/codex_e2e_compact_semantic_v1")"
          PROVIDER_CLAUDE_RUN_DIR="$(find_latest_run_dir "$GITHUB_WORKSPACE/docs_tmp/tmux_captures/scenarios/nightly_provider/claude_e2e_compact_semantic_v1")"

          echo "RESIZE_RUN_DIR=$RESIZE_RUN_DIR" >> "$GITHUB_ENV"
          echo "CONCURRENCY_RUN_DIR=$CONCURRENCY_RUN_DIR" >> "$GITHUB_ENV"
          echo "PROVIDER_CODEX_RUN_DIR=$PROVIDER_CODEX_RUN_DIR" >> "$GITHUB_ENV"
          echo "PROVIDER_CLAUDE_RUN_DIR=$PROVIDER_CLAUDE_RUN_DIR" >> "$GITHUB_ENV"
          echo "PROVIDER_CODEX_SKIP_REASON=$provider_codex_skip_reason" >> "$GITHUB_ENV"
          echo "PROVIDER_CLAUDE_SKIP_REASON=$provider_claude_skip_reason" >> "$GITHUB_ENV"
          echo "PROVIDER_RC=$provider_rc" >> "$GITHUB_ENV"
          echo "STRESS_RC=$stress_rc" >> "$GITHUB_ENV"
          exit 0

      - name: Validate tier3 runs (warn-only)
        if: ${{ always() }}
        run: |
          set +e
          rc=0
          for run_dir in "$RESIZE_RUN_DIR" "$CONCURRENCY_RUN_DIR" "$PROVIDER_CODEX_RUN_DIR" "$PROVIDER_CLAUDE_RUN_DIR"; do
            if [[ -n "$run_dir" ]]; then
              python scripts/validate_tmux_capture_run.py --run-dir "$run_dir" --strict
              if [[ $? -ne 0 ]]; then
                rc=1
              fi
              python scripts/generate_tmux_run_gallery.py --run-dir "$run_dir" --output-html "$run_dir/gallery.html"
              if [[ $? -ne 0 ]]; then
                rc=1
              fi
            fi
          done
          echo "VALIDATION_RC=$rc" >> "$GITHUB_ENV"
          exit 0

      - name: Emit tier3 run health JSON
        if: ${{ always() }}
        run: |
          python scripts/export_phase4_tier3_health.py \
            --mode nightly \
            --provider-codex-run-dir "${PROVIDER_CODEX_RUN_DIR:-}" \
            --provider-claude-run-dir "${PROVIDER_CLAUDE_RUN_DIR:-}" \
            --provider-codex-skip-reason "${PROVIDER_CODEX_SKIP_REASON:-}" \
            --provider-claude-skip-reason "${PROVIDER_CLAUDE_SKIP_REASON:-}" \
            --resize-storm-run-dir "${RESIZE_RUN_DIR:-}" \
            --concurrency-run-dir "${CONCURRENCY_RUN_DIR:-}" \
            --provider-rc "${PROVIDER_RC:-}" \
            --stress-rc "${STRESS_RC:-}" \
            --validation-rc "${VALIDATION_RC:-}" \
            --output-json "$GITHUB_WORKSPACE/docs_tmp/tmux_captures/phase4_tier3_run_health_nightly.json"

      - name: Build tier3 gallery index
        if: ${{ always() }}
        run: |
          bash scripts/rebuild_phase4_tier3_galleries.sh "$GITHUB_WORKSPACE/docs_tmp/tmux_captures/scenarios"

      - name: Aggregate tier3 health trends
        if: ${{ always() }}
        run: |
          python scripts/aggregate_phase4_tier3_health.py \
            --glob "$GITHUB_WORKSPACE/docs_tmp/tmux_captures/phase4_tier3_run_health*.json" \
            --output-json "$GITHUB_WORKSPACE/docs_tmp/tmux_captures/phase4_tier3_trend_aggregate.json"

      - name: Check tier3 trend thresholds (warn)
        if: ${{ always() }}
        run: |
          python scripts/check_phase4_tier3_trends.py \
            --aggregate-json "$GITHUB_WORKSPACE/docs_tmp/tmux_captures/phase4_tier3_trend_aggregate.json" \
            --mode warn \
            --max-interval-p95-ms 1200 \
            --max-line-churn-p95 0.20 \
            --output-json "$GITHUB_WORKSPACE/docs_tmp/tmux_captures/phase4_tier3_trend_check.json"

      - name: Add tier3 nightly summary
        if: ${{ always() }}
        run: |
          {
            echo "## tmux phase4 tier3 nightly (warn-only)"
            echo ""
            echo "- provider_rc: \`${PROVIDER_RC:-unknown}\`"
            echo "- stress_rc: \`${STRESS_RC:-unknown}\`"
            echo "- validation_rc: \`${VALIDATION_RC:-unknown}\`"
            echo ""
            echo "- resize storm run: \`${RESIZE_RUN_DIR:-missing}\`"
            echo "- concurrency run: \`${CONCURRENCY_RUN_DIR:-missing}\`"
            echo "- provider codex run: \`${PROVIDER_CODEX_RUN_DIR:-skipped}\`"
            echo "- provider codex skip reason: \`${PROVIDER_CODEX_SKIP_REASON:-none}\`"
            echo "- provider claude run: \`${PROVIDER_CLAUDE_RUN_DIR:-skipped}\`"
            echo "- provider claude skip reason: \`${PROVIDER_CLAUDE_SKIP_REASON:-none}\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload tier3 nightly artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: tmux-phase4-tier3-nightly-artifacts
          path: |
            docs_tmp/tmux_captures/scenarios/phase4_replay/resize_storm_overlay_v1
            docs_tmp/tmux_captures/scenarios/phase4_replay/subagents_concurrency_20_v1
            docs_tmp/tmux_captures/scenarios/nightly_provider/codex_e2e_compact_semantic_v1
            docs_tmp/tmux_captures/scenarios/nightly_provider/claude_e2e_compact_semantic_v1
            docs_tmp/tmux_captures/targets_logs
            docs_tmp/tmux_captures/phase4_tier3_run_health_nightly.json
            docs_tmp/tmux_captures/phase4_tier3_gallery_index.md
            docs_tmp/tmux_captures/phase4_tier3_gallery_index.json
            docs_tmp/tmux_captures/phase4_tier3_trend_aggregate.json
            docs_tmp/tmux_captures/phase4_tier3_trend_check.json
          if-no-files-found: ignore
