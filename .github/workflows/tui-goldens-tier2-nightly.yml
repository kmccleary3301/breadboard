name: tui-goldens-tier2-nightly

on:
  schedule:
    - cron: "0 9 * * *"
  workflow_dispatch:

jobs:
  tier2_matrix_report:
    name: "Tier2 ${{ matrix.lane }} / ${{ matrix.tui_preset }} / w${{ matrix.width }} / ${{ matrix.mode }}"
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        include:
          - lane: u1
            tui_preset: breadboard_default
            width: "120"
            mode: unicode-color
            ascii: "0"
            no_color: "0"
          - lane: u1
            tui_preset: claude_code_like
            width: "120"
            mode: unicode-color
            ascii: "0"
            no_color: "0"
          - lane: u1
            tui_preset: codex_cli_like
            width: "120"
            mode: unicode-color
            ascii: "0"
            no_color: "0"
          - lane: u2
            tui_preset: breadboard_default
            width: "100"
            mode: unicode-color
            ascii: "0"
            no_color: "0"
          - lane: u2
            tui_preset: claude_code_like
            width: "120"
            mode: unicode-color
            ascii: "0"
            no_color: "0"
          - lane: u2
            tui_preset: codex_cli_like
            width: "160"
            mode: unicode-color
            ascii: "0"
            no_color: "0"
          - lane: u3
            tui_preset: breadboard_default
            width: "100"
            mode: ascii-no-color
            ascii: "1"
            no_color: "1"
          - lane: u3
            tui_preset: claude_code_like
            width: "120"
            mode: unicode-color
            ascii: "0"
            no_color: "0"
          - lane: u3
            tui_preset: codex_cli_like
            width: "160"
            mode: unicode-color
            ascii: "0"
            no_color: "0"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install deps (tui_skeleton)
        working-directory: tui_skeleton
        run: npm ci

      - name: Run tier2 report compare
        working-directory: tui_skeleton
        run: |
          MANIFEST="ui_baselines/${{ matrix.lane }}/manifests/${{ matrix.lane }}.yaml"
          RUNS_ROOT="ui_baselines/${{ matrix.lane }}/_runs_tier2"
          BLESSED_ROOT="ui_baselines/${{ matrix.lane }}/scenarios"

          if [[ "${{ matrix.no_color }}" == "1" ]]; then
            export NO_COLOR=1
          else
            unset NO_COLOR || true
          fi
          export BREADBOARD_ASCII="${{ matrix.ascii }}"
          export BREADBOARD_TUI_PRESET="${{ matrix.tui_preset }}"

          node --import tsx scripts/run_tui_goldens.ts \
            --manifest "$MANIFEST" \
            --out "$RUNS_ROOT" \
            --config ../agent_configs/codex_cli_gpt51mini_e4_live.yaml \
            --max-width "${{ matrix.width }}"

          LATEST_RUN="$(ls -td "$RUNS_ROOT"/run-* | head -n 1)"
          echo "LATEST_RUN=$LATEST_RUN" >> "$GITHUB_ENV"

          node --import tsx scripts/compare_tui_goldens.ts \
            --manifest "$MANIFEST" \
            --candidate "$LATEST_RUN" \
            --blessed-root "$BLESSED_ROOT" \
            --summary

      - name: Append summary
        run: |
          python - <<'PY'
          import glob, json, os
          lane = os.environ["LANE"]
          roots = sorted(glob.glob(f"tui_skeleton/ui_baselines/{lane}/_runs_tier2/run-*/_diffs/index.json"))
          if not roots:
              print("No diff summary found")
              raise SystemExit(0)
          p = roots[-1]
          with open(p, "r", encoding="utf-8") as f:
              d = json.load(f)
          total = int(d.get("okCount", 0)) + int(d.get("failCount", 0))
          lines = [
              f"### Tier2 {lane} summary",
              f"- preset: `{os.environ.get('PRESET')}`",
              f"- mode: `{os.environ.get('MODE')}`",
              f"- width: `{os.environ.get('WIDTH')}`",
              f"- scenarios: `{total}`",
              f"- ok: `{d.get('okCount', 0)}`",
              f"- fail: `{d.get('failCount', 0)}`",
              f"- diff index: `{p}`",
              "",
          ]
          summary = os.environ.get("GITHUB_STEP_SUMMARY")
          if summary:
              with open(summary, "a", encoding="utf-8") as out:
                  out.write("\n".join(lines))
          print("\n".join(lines))
          PY
        env:
          LANE: ${{ matrix.lane }}
          PRESET: ${{ matrix.tui_preset }}
          MODE: ${{ matrix.mode }}
          WIDTH: ${{ matrix.width }}

      - name: Upload tier2 artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tui-tier2-${{ matrix.lane }}-${{ matrix.tui_preset }}-w${{ matrix.width }}-${{ matrix.mode }}
          path: |
            tui_skeleton/ui_baselines/${{ matrix.lane }}/_runs_tier2
          if-no-files-found: ignore

  runtime_triage_pack:
    name: "Runtime quick triage pack"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install deps (tui_skeleton)
        working-directory: tui_skeleton
        run: npm ci

      - name: Build quick triage snapshots
        working-directory: tui_skeleton
        run: |
          npm run runtime:triage:quick -- \
            --out-dir ../artifacts/runtime_triage_nightly

      - name: Upload runtime triage pack
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: runtime-triage-nightly
          path: |
            artifacts/runtime_triage_nightly/**
          if-no-files-found: ignore

  todo_preview_churn_gate:
    name: "Todo preview churn gate"
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install deps (tui_skeleton)
        working-directory: tui_skeleton
        run: npm ci

      - name: Compute churn metrics (preview-only)
        working-directory: tui_skeleton
        run: |
          node --import tsx scripts/todo_preview_churn_gate.ts \
            --input ui_baselines/u1/scenarios/todo_preview_churn_gate/input/events.jsonl \
            --config ../agent_configs/codex_cli_gpt51mini_e4_live.yaml \
            --out ../artifacts/todo_preview_churn_nightly/summary.json \
            --strict

      - name: Append summary
        if: always()
        run: |
          python - <<'PY'
          import json, os, pathlib
          p = pathlib.Path("artifacts/todo_preview_churn_nightly/summary.json")
          if not p.exists():
              raise SystemExit(0)
          d = json.loads(p.read_text(encoding="utf-8"))
          lines = [
              "### Todo preview churn gate",
              f"- churn events: `{d.get('churn')}`",
              f"- todo events: `{d.get('todoEvents')}`",
              f"- input: `{d.get('input')}`",
              "",
          ]
          summary = os.environ.get("GITHUB_STEP_SUMMARY")
          if summary:
              with open(summary, "a", encoding="utf-8") as out:
                  out.write("\\n".join(lines))
          print("\\n".join(lines))
          PY

      - name: Upload churn artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: todo-preview-churn-nightly
          path: |
            artifacts/todo_preview_churn_nightly/**
          if-no-files-found: ignore
