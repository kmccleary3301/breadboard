name: phase4-release-tag-preflight

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      target_sha:
        description: "Commit SHA to validate (default: workflow SHA)"
        required: false

permissions:
  actions: read
  contents: read

jobs:
  require-phase4-gate-before-release-tag:
    name: require phase4 fullpane gate before release tag
    runs-on: ubuntu-latest
    steps:
      - name: Resolve target SHA
        run: |
          set -euo pipefail
          target_sha="${{ github.event.inputs.target_sha || '' }}"
          if [[ -z "$target_sha" ]]; then
            target_sha="$GITHUB_SHA"
          fi
          echo "TARGET_SHA=$target_sha" >> "$GITHUB_ENV"

      - name: Verify successful strict gate run on target SHA
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          python - <<'PY'
import json
import os
import sys
import urllib.parse
import urllib.request

repo = os.environ["GITHUB_REPOSITORY"]
sha = os.environ["TARGET_SHA"]
token = os.environ["GITHUB_TOKEN"]

query = urllib.parse.urlencode(
    {
        "head_sha": sha,
        "status": "completed",
        "per_page": 50,
    }
)
url = f"https://api.github.com/repos/{repo}/actions/workflows/tmux-phase4-fullpane-gate.yml/runs?{query}"
req = urllib.request.Request(
    url,
    headers={
        "Authorization": f"Bearer {token}",
        "Accept": "application/vnd.github+json",
        "X-GitHub-Api-Version": "2022-11-28",
        "User-Agent": "phase4-release-tag-preflight",
    },
)
with urllib.request.urlopen(req, timeout=30) as resp:
    payload = json.loads(resp.read().decode("utf-8"))

runs = payload.get("workflow_runs", [])
success = [r for r in runs if r.get("conclusion") == "success"]
if not success:
    print(
        f"No successful 'tmux-phase4-fullpane-gate' run found for commit {sha}. "
        "Run the strict gate workflow first, then cut the release tag.",
        file=sys.stderr,
    )
    sys.exit(1)

success.sort(key=lambda r: r.get("updated_at") or "", reverse=True)
best = success[0]
print(f"Found successful strict gate run: id={best.get('id')} updated_at={best.get('updated_at')}")
with open(os.environ["GITHUB_ENV"], "a", encoding="utf-8") as env:
    env.write(f"GATE_RUN_ID={best.get('id')}\\n")
    env.write(f"GATE_RUN_URL={best.get('html_url')}\\n")
PY

      - name: Add preflight summary
        if: ${{ always() }}
        run: |
          {
            echo "## Phase4 Release Tag Preflight"
            echo ""
            echo "- target_sha: \`${TARGET_SHA:-missing}\`"
            echo "- strict_gate_run_id: \`${GATE_RUN_ID:-missing}\`"
            echo "- strict_gate_run_url: \`${GATE_RUN_URL:-missing}\`"
          } >> "$GITHUB_STEP_SUMMARY"
