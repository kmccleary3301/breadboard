name: tmux-e2e-soft-gate

on:
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: "30 7 * * *"

jobs:
  tmux-harness-selfcheck:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install minimal dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install pillow pytest

      - name: Start synthetic tmux target
        run: |
          tmux new-session -d -x 160 -y 45 -s breadboard_test_ci_soft_gate "cd $GITHUB_WORKSPACE && exec bash"
          tmux new-session -d -x 160 -y 45 -s breadboard_test_ci_inputbus "cd $GITHUB_WORKSPACE && exec bash"
          tmux new-session -d -x 160 -y 45 -s breadboard_test_ci_resize "cd $GITHUB_WORKSPACE && exec bash"

      - name: Run tmux capture scenario (deterministic local)
        run: |
          python scripts/run_tmux_capture_scenario.py \
            --target breadboard_test_ci_soft_gate:0.0 \
            --scenario ci/soft_gate_local \
            --actions "$GITHUB_WORKSPACE/config/tmux_scenario_actions/ci/soft_gate_local.json" \
            --out-root "$GITHUB_WORKSPACE/docs_tmp/tmux_captures/scenarios" \
            --duration 6 \
            --interval 0.5 \
            --pre-sleep 0.1 \
            --post-sleep 0.1 \
            --must-contain semantic-ready \
            --semantic-timeout 3 \
            --capture-label ci_soft_gate_local

      - name: Resolve latest run dir
        run: |
          RUN_DIR="$(find "$GITHUB_WORKSPACE/docs_tmp/tmux_captures/scenarios/ci/soft_gate_local" -name scenario_manifest.json -print | sort | tail -n1 | xargs dirname)"
          test -f "$RUN_DIR/scenario_manifest.json"
          test -d "$RUN_DIR/frames"
          python scripts/validate_tmux_capture_run.py --run-dir "$RUN_DIR" --strict
          echo "RUN_DIR=$RUN_DIR" >> "$GITHUB_ENV"

      - name: Create synthetic golden baseline (copy run)
        run: |
          GOLDEN_DIR="$GITHUB_WORKSPACE/docs_tmp/tmux_captures/goldens/ci_soft_gate_local/baseline"
          rm -rf "$GOLDEN_DIR"
          mkdir -p "$(dirname "$GOLDEN_DIR")"
          cp -R "$RUN_DIR" "$GOLDEN_DIR"
          echo "GOLDEN_DIR=$GOLDEN_DIR" >> "$GITHUB_ENV"

      - name: Compare run to golden (warn mode)
        run: |
          python scripts/compare_tmux_run_to_golden.py \
            --run-dir "$RUN_DIR" \
            --golden-dir "$GOLDEN_DIR" \
            --scenario ci/soft_gate_local \
            --provider unknown \
            --thresholds "$GITHUB_WORKSPACE/config/tmux_golden_thresholds.yaml" \
            --fail-mode warn \
            --redact \
            --output-json "$RUN_DIR/comparison_report.json" \
            --output-md "$RUN_DIR/comparison_report.md"

      - name: Add summary to PR
        run: |
          echo "## tmux harness self-check" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          cat "$RUN_DIR/comparison_report.md" >> "$GITHUB_STEP_SUMMARY"

      - name: Run input-bus local semantics self-check
        run: |
          python scripts/run_tmux_capture_scenario.py \
            --target breadboard_test_ci_inputbus:0.0 \
            --scenario ci/input_bus_local_v1 \
            --actions "$GITHUB_WORKSPACE/config/tmux_scenario_actions/ci/input_bus_local_v1.json" \
            --out-root "$GITHUB_WORKSPACE/docs_tmp/tmux_captures/scenarios" \
            --duration 8 \
            --interval 0.5 \
            --pre-sleep 0.1 \
            --post-sleep 0.1 \
            --semantic-timeout 3 \
            --capture-label ci_input_bus_local_v1

      - name: Run resize action smoke self-check
        run: |
          python scripts/run_tmux_capture_scenario.py \
            --target breadboard_test_ci_resize:0.0 \
            --scenario ci/resize_action_smoke_v1 \
            --actions "$GITHUB_WORKSPACE/config/tmux_scenario_actions/ci/resize_action_smoke_v1.json" \
            --out-root "$GITHUB_WORKSPACE/docs_tmp/tmux_captures/scenarios" \
            --duration 8 \
            --interval 0.5 \
            --pre-sleep 0.1 \
            --post-sleep 0.1 \
            --semantic-timeout 3 \
            --capture-label ci_resize_action_smoke_v1

      - name: Validate latest input-bus run
        run: |
          INPUT_RUN_DIR="$(find "$GITHUB_WORKSPACE/docs_tmp/tmux_captures/scenarios/ci/input_bus_local_v1" -name scenario_manifest.json -print | sort | tail -n1 | xargs dirname)"
          test -f "$INPUT_RUN_DIR/scenario_manifest.json"
          test -d "$INPUT_RUN_DIR/frames"
          python scripts/validate_tmux_capture_run.py --run-dir "$INPUT_RUN_DIR" --strict
          echo "INPUT_RUN_DIR=$INPUT_RUN_DIR" >> "$GITHUB_ENV"

      - name: Validate latest resize smoke run
        run: |
          RESIZE_RUN_DIR="$(find "$GITHUB_WORKSPACE/docs_tmp/tmux_captures/scenarios/ci/resize_action_smoke_v1" -name scenario_manifest.json -print | sort | tail -n1 | xargs dirname)"
          test -f "$RESIZE_RUN_DIR/scenario_manifest.json"
          test -d "$RESIZE_RUN_DIR/frames"
          python scripts/validate_tmux_capture_run.py --run-dir "$RESIZE_RUN_DIR" --strict
          echo "RESIZE_RUN_DIR=$RESIZE_RUN_DIR" >> "$GITHUB_ENV"

      - name: Append input-bus summary to PR
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### tmux input-bus local self-check" >> "$GITHUB_STEP_SUMMARY"
          echo "- run: \`$INPUT_RUN_DIR\`" >> "$GITHUB_STEP_SUMMARY"
          python - <<'PY'
          import json, os
          p = os.path.join(os.environ["INPUT_RUN_DIR"], "run_summary.json")
          with open(p, "r", encoding="utf-8") as f:
              d = json.load(f)
          lines = [
              f"- scenario_result: `{d.get('scenario_result')}`",
              f"- poller_exit_code: `{d.get('poller_exit_code')}`",
              f"- action_error: `{d.get('action_error')}`",
          ]
          summary = os.environ.get("GITHUB_STEP_SUMMARY")
          if summary:
              with open(summary, "a", encoding="utf-8") as out:
                  out.write("\n".join(lines) + "\n")
          print("\n".join(lines))
          PY

      - name: Append resize smoke summary to PR
        if: ${{ always() }}
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### tmux resize action smoke self-check" >> "$GITHUB_STEP_SUMMARY"
          if [ -n "${RESIZE_RUN_DIR:-}" ]; then
            echo "- run: \`$RESIZE_RUN_DIR\`" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- run: `(missing)`" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload tmux artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: tmux-e2e-soft-gate-artifacts
          path: |
            docs_tmp/tmux_captures/scenarios/ci/soft_gate_local
            docs_tmp/tmux_captures/scenarios/ci/input_bus_local_v1
            docs_tmp/tmux_captures/scenarios/ci/resize_action_smoke_v1
            docs_tmp/tmux_captures/goldens/ci_soft_gate_local

  tmux-phase4-replay:
    name: tmux phase4 replay (warn)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: requirements.txt

      - name: Install engine dependencies
        run: |
          python -m pip install -r requirements.txt
          # Needed for PNG render in tmux capture artifacts.
          python -m pip install pillow

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: tui_skeleton/package-lock.json

      - name: Install TUI dependencies
        working-directory: tui_skeleton
        run: npm ci

      - name: Build TUI (for --use-dist entrypoint)
        working-directory: tui_skeleton
        env:
          BREADBOARD_SKIP_LOCAL_BIN_INSTALL: "1"
          BREADBOARD_INSTALL_QUIET: "1"
        run: npm run build

      - name: Start phase4 replay tmux targets
        env:
          RAY_SCE_LOCAL_MODE: "1"
        run: |
          bash scripts/start_tmux_phase4_replay_target.sh --session breadboard_test_ci_phase4_todo --cols 160 --rows 45 --port 9103 --use-dist
          bash scripts/start_tmux_phase4_replay_target.sh --session breadboard_test_ci_phase4_streaming --cols 160 --rows 45 --port 9101 --use-dist
          bash scripts/start_tmux_phase4_replay_target.sh --session breadboard_test_ci_phase4_subagents --cols 160 --rows 45 --port 9102 --use-dist

      - name: Run phase4 replay scenarios
        run: |
          python scripts/run_tmux_capture_scenario.py \
            --target breadboard_test_ci_phase4_todo:0.0 \
            --scenario phase4_replay/todo_preview_v1 \
            --actions "$GITHUB_WORKSPACE/config/tmux_scenario_actions/phase4_replay/todo_preview_v1.json" \
            --out-root "$GITHUB_WORKSPACE/docs_tmp/tmux_captures/scenarios" \
            --duration 35 \
            --interval 0.5 \
            --pre-sleep 0.2 \
            --post-sleep 0.2 \
            --semantic-timeout 10 \
            --capture-label phase4_replay_todo_preview_v1

          python scripts/run_tmux_capture_scenario.py \
            --target breadboard_test_ci_phase4_streaming:0.0 \
            --scenario phase4_replay/streaming_v1 \
            --actions "$GITHUB_WORKSPACE/config/tmux_scenario_actions/phase4_replay/streaming_v1.json" \
            --out-root "$GITHUB_WORKSPACE/docs_tmp/tmux_captures/scenarios" \
            --duration 40 \
            --interval 0.5 \
            --pre-sleep 0.2 \
            --post-sleep 0.2 \
            --semantic-timeout 10 \
            --capture-label phase4_replay_streaming_v1

          python scripts/run_tmux_capture_scenario.py \
            --target breadboard_test_ci_phase4_subagents:0.0 \
            --scenario phase4_replay/subagents_v1 \
            --actions "$GITHUB_WORKSPACE/config/tmux_scenario_actions/phase4_replay/subagents_v1.json" \
            --out-root "$GITHUB_WORKSPACE/docs_tmp/tmux_captures/scenarios" \
            --duration 40 \
            --interval 0.5 \
            --pre-sleep 0.2 \
            --post-sleep 0.2 \
            --semantic-timeout 10 \
            --capture-label phase4_replay_subagents_v1

      - name: Validate phase4 replay runs (strict bundle integrity)
        if: ${{ always() }}
        run: |
          TODO_RUN_DIR="$(find "$GITHUB_WORKSPACE/docs_tmp/tmux_captures/scenarios/phase4_replay/todo_preview_v1" -name scenario_manifest.json -print | sort | tail -n1 | xargs dirname)"
          STREAM_RUN_DIR="$(find "$GITHUB_WORKSPACE/docs_tmp/tmux_captures/scenarios/phase4_replay/streaming_v1" -name scenario_manifest.json -print | sort | tail -n1 | xargs dirname)"
          SUBAGENTS_RUN_DIR="$(find "$GITHUB_WORKSPACE/docs_tmp/tmux_captures/scenarios/phase4_replay/subagents_v1" -name scenario_manifest.json -print | sort | tail -n1 | xargs dirname)"
          python scripts/validate_tmux_capture_run.py --run-dir "$TODO_RUN_DIR" --strict
          python scripts/validate_tmux_capture_run.py --run-dir "$STREAM_RUN_DIR" --strict
          python scripts/validate_tmux_capture_run.py --run-dir "$SUBAGENTS_RUN_DIR" --strict
          echo "TODO_RUN_DIR=$TODO_RUN_DIR" >> "$GITHUB_ENV"
          echo "STREAM_RUN_DIR=$STREAM_RUN_DIR" >> "$GITHUB_ENV"
          echo "SUBAGENTS_RUN_DIR=$SUBAGENTS_RUN_DIR" >> "$GITHUB_ENV"

      - name: Add summary to PR
        if: ${{ always() }}
        run: |
          echo "## tmux phase4 replay (warn)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- todo: \`$TODO_RUN_DIR\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- streaming: \`$STREAM_RUN_DIR\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- subagents: \`$SUBAGENTS_RUN_DIR\`" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload phase4 replay artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: tmux-phase4-replay-artifacts
          path: |
            docs_tmp/tmux_captures/scenarios/phase4_replay/todo_preview_v1
            docs_tmp/tmux_captures/scenarios/phase4_replay/streaming_v1
            docs_tmp/tmux_captures/scenarios/phase4_replay/subagents_v1
