name: phase4-release-tag-preflight-manual

on:
  workflow_dispatch:

permissions:
  actions: read
  contents: read

jobs:
  require-phase4-gate-before-release-tag:
    name: require phase4 fullpane gate before release tag
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve target SHA
        run: |
          set -euo pipefail
          target_sha="$GITHUB_SHA"
          echo "TARGET_SHA=$target_sha" >> "$GITHUB_ENV"

      - name: Verify successful strict gate run on target SHA
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          python scripts/verify_phase4_gate_run_for_sha.py \
            --sha "$TARGET_SHA" \
            --repo "$GITHUB_REPOSITORY" \
            --token "$GITHUB_TOKEN" \
            --output-json "$RUNNER_TEMP/phase4_release_preflight_manual.json" \
            --env-file "$GITHUB_ENV"

      - name: Add preflight summary
        if: ${{ always() }}
        run: |
          {
            echo "## Phase4 Release Tag Preflight (Manual)"
            echo ""
            echo "- target_sha: \`${TARGET_SHA:-missing}\`"
            echo "- strict_gate_run_id: \`${GATE_RUN_ID:-missing}\`"
            echo "- strict_gate_run_url: \`${GATE_RUN_URL:-missing}\`"
          } >> "$GITHUB_STEP_SUMMARY"
