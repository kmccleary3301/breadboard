name: LongRun Phase2 Warn Lane

on:
  workflow_dispatch:
    inputs:
      strict_mode:
        description: "When true, fail the workflow on pilot test/script errors"
        type: boolean
        required: false
        default: false
  schedule:
    - cron: "0 9 * * *"
  pull_request:
    paths:
      - "agentic_coder_prototype/longrun/**"
      - "scripts/run_longrun_phase1_pilot.py"
      - "scripts/validate_longrun_phase1_scenario_contract.py"
      - "tests/test_run_longrun_phase1_pilot.py"
      - "tests/test_validate_longrun_phase1_scenario_contract.py"
      - ".github/workflows/longrun-phase2-warn.yml"

jobs:
  longrun_warn:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install pytest pyyaml

      - name: Pilot smoke tests (warn-only)
        continue-on-error: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.strict_mode != 'true' }}
        run: |
          pytest -q tests/test_run_longrun_phase1_pilot.py tests/test_validate_longrun_phase1_scenario_contract.py

      - name: Run deterministic pilot matrix (warn-only)
        continue-on-error: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.strict_mode != 'true' }}
        run: |
          python scripts/run_longrun_phase1_pilot.py \
            --json-out artifacts/longrun/pilot/longrun_phase1_pilot_v1.json \
            --markdown-out artifacts/longrun/pilot/longrun_phase1_pilot_summary.md

      - name: Validate pilot artifact shape (warn-only)
        continue-on-error: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.strict_mode != 'true' }}
        run: |
          python scripts/validate_longrun_phase2_warn_artifacts.py \
            --json artifacts/longrun/pilot/longrun_phase1_pilot_v1.json

      - name: Validate pilot scenario contract (warn-only)
        continue-on-error: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.strict_mode != 'true' }}
        run: |
          python scripts/validate_longrun_phase1_scenario_contract.py \
            --pilot-json artifacts/longrun/pilot/longrun_phase1_pilot_v1.json \
            --contract-json config/longrun/phase1_scenario_contract_v1.json \
            --report-json artifacts/longrun/pilot/longrun_phase1_scenario_contract_report.json

      - name: Upload warn-lane artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: longrun-phase2-warn-artifacts
          path: artifacts/longrun/pilot/**
          if-no-files-found: warn
