name: CI

on:
  push:
  pull_request:

jobs:
  compat_break_guard:
    name: Compat break guard
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const core = require('@actions/core');
            const pr = context.payload.pull_request;
            if (!pr) {
              core.info('No pull_request context; skipping.');
              return;
            }
            const labels = new Set((pr.labels || []).map(l => l.name));
            const body = pr.body || '';
            const bodyChecked = /\[x\]\s*\*\*Compat break\*\*/i.test(body) || /\[x\]\s*Compat break/i.test(body);

            const patterns = [
              "agentic_coder_prototype/state/session_state.py",
              "agentic_coder_prototype/api/cli_bridge/events.py",
              "agentic_coder_prototype/api/cli_bridge/service.py",
              "agentic_coder_prototype/api/cli_bridge/app.py",
              "implementations/tools/defs/",
              "implementations/system_prompts/",
              "agent_configs/",
              "agentic_coder_prototype/tools.py",
              "agentic_coder_prototype/tool_calling/",
              "agentic_coder_prototype/tool_prompt_planner.py",
              "agentic_coder_prototype/guardrail_orchestrator.py",
              "agentic_coder_prototype/permission_broker.py",
              "agentic_coder_prototype/guardrails/",
              "agentic_coder_prototype/provider_runtime.py",
              "agentic_coder_prototype/provider_ir.py",
              "agentic_coder_prototype/agent_llm_openai.py",
              "agentic_coder_prototype/compilation/system_prompt_compiler.py",
              "agentic_coder_prototype/parity.py",
              "scripts/run_parity_replays.py",
              "scripts/replay_opencode_session.py",
              "tests/fixtures/compat/",
            ];

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              per_page: 100,
            });
            const touched = files.filter(f => patterns.some(p => f.filename === p || f.filename.startsWith(p)));
            const fixtureTouched = files.filter(f => f.filename.startsWith("tests/fixtures/compat/"));
            if (touched.length === 0 && fixtureTouched.length === 0) {
              core.info('No parity-kernel paths touched.');
              return;
            }

            const hasLabel = labels.has('compat-break') || labels.has('compat_break') || labels.has('compat');
            if (!hasLabel && !bodyChecked) {
              core.setFailed(
                [
                  "Compat-break label required for parity-kernel changes.",
                  "Add label 'compat-break' or check the Compat break box in the PR template.",
                  "Touched paths:",
                  ...touched.map(f => `- ${f.filename}`),
                  ...(fixtureTouched.length ? ["Compat fixtures changed:", ...fixtureTouched.map(f => `- ${f.filename}`)] : []),
                ].join("\\n")
              );
            } else {
              core.info('Compat-break label/body present for parity-kernel changes.');
            }

  compat_core:
    name: Compat core (ubuntu)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: requirements-core.txt

      - name: Install core dependencies
        run: python -m pip install -r requirements-core.txt

      - name: Core install smoke
        run: python -c "import breadboard"

      - name: Kernel import lint
        run: python tools/import_lint.py

      - name: Core compat suite
        env:
          RAY_SCE_LOCAL_MODE: "1"
          AGENT_SCHEMA_V2_ENABLED: "1"
          OPENAI_API_KEY: compat-dummy
          ANTHROPIC_API_KEY: compat-dummy
          OPENROUTER_API_KEY: compat-dummy
          BB_COMPAT_WORKSPACE_ROOT: /tmp/bb_compat_workspaces
        run: >
          python -m pytest -q
          tests/test_request_body_golden.py
          tests/test_tool_schema_golden.py
          tests/test_ctrees_determinism_corpus.py
          tests/test_atp_route_gating.py
          tests/test_evolake_route_gating.py
          tests/test_import_boundaries.py
          tests/test_kernel_imports.py
          tests/test_vsock_protocol.py

  compat_break_regen:
    name: Compat break regen guard
    if: ${{ github.event_name == 'pull_request' && contains(join(github.event.pull_request.labels.*.name, ','), 'compat-break') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: requirements-core.txt

      - name: Install core dependencies
        run: python -m pip install -r requirements-core.txt

      - name: Regenerate request-body fixtures
        env:
          RAY_SCE_LOCAL_MODE: "1"
          AGENT_SCHEMA_V2_ENABLED: "1"
          OPENAI_API_KEY: compat-dummy
          ANTHROPIC_API_KEY: compat-dummy
          OPENROUTER_API_KEY: compat-dummy
          BB_COMPAT_WORKSPACE_ROOT: /tmp/bb_compat_workspaces
        run: python scripts/compat_dump_request_bodies.py

      - name: Ensure fixtures checked in
        run: git diff --exit-code tests/fixtures/compat/request_bodies

  firecracker_atp:
    name: ATP Firecracker (self-hosted)
    if: ${{ vars.ATP_FIRECRACKER_SMOKE == '1' }}
    runs-on: [self-hosted, linux]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: requirements.txt

      - name: Install dependencies
        run: python -m pip install -r requirements.txt

      - name: Run Firecracker ATP smoke + bench
        env:
          FIRECRACKER_SNAPSHOT: ${{ vars.FIRECRACKER_SNAPSHOT }}
          FIRECRACKER_SNAPSHOT_MEM: ${{ vars.FIRECRACKER_SNAPSHOT_MEM }}
          FIRECRACKER_SNAPSHOT_VSOCK: ${{ vars.FIRECRACKER_SNAPSHOT_VSOCK }}
          FIRECRACKER_ROOTFS: ${{ vars.FIRECRACKER_ROOTFS }}
          FIRECRACKER_BIN: ${{ vars.FIRECRACKER_BIN }}
          FIRECRACKER_VSOCK_PORT: ${{ vars.FIRECRACKER_VSOCK_PORT }}
          BUDGET_P95_MS: ${{ vars.ATP_REPL_BUDGET_P95_MS }}
          ITERS: ${{ vars.ATP_REPL_BENCH_ITERS }}
          ATP_REPL_BENCH_VALIDATE: ${{ vars.ATP_REPL_BENCH_VALIDATE || '1' }}
          ATP_REPL_BENCH_SUMMARY_PATH: ${{ vars.ATP_REPL_BENCH_SUMMARY_PATH }}
          ATP_REPL_LOAD_VALIDATE: ${{ vars.ATP_REPL_LOAD_VALIDATE || '1' }}
          ATP_REPL_LOAD_CONCURRENCY: ${{ vars.ATP_REPL_LOAD_CONCURRENCY }}
          ATP_REPL_LOAD_ITERS: ${{ vars.ATP_REPL_LOAD_ITERS }}
          ATP_REPL_LOAD_SUMMARY_PATH: ${{ vars.ATP_REPL_LOAD_SUMMARY_PATH }}
        run: bash scripts/atp_firecracker_ci.sh

  tui:
    name: TUI (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: tui_skeleton/package-lock.json

      - name: Install dependencies
        working-directory: tui_skeleton
        run: npm ci

      - name: Typecheck
        working-directory: tui_skeleton
        run: npm run typecheck

      - name: Unit tests
        working-directory: tui_skeleton
        run: npm test

      - name: TUI goldens (report-only)
        working-directory: tui_skeleton
        run: npm run tui:goldens:report

      - name: Claude alignment (report-only)
        working-directory: tui_skeleton
        run: npm run claude:compare:report

      - name: TUI goldens (strict gate, ubuntu only)
        if: ${{ matrix.os == 'ubuntu-latest' }}
        working-directory: tui_skeleton
        run: npm run tui:goldens:strict

      - name: Upload TUI golden artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tui-goldens-${{ matrix.os }}
          path: |
            misc/tui_goldens/artifacts/run-*/**
          if-no-files-found: ignore

      - name: Upload Claude alignment artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: claude-compare-${{ matrix.os }}
          path: |
            misc/tui_goldens/claude_compare/run-*/**
          if-no-files-found: ignore

      - name: Build
        working-directory: tui_skeleton
        env:
          BREADBOARD_SKIP_LOCAL_BIN_INSTALL: "1"
          BREADBOARD_INSTALL_QUIET: "1"
        run: npm run build

      - name: CLI smoke (--help)
        working-directory: tui_skeleton
        run: node dist/main.js --help

      - name: npm pack smoke
        run: node scripts/cli_pack_smoke.mjs

  live_smoke:
    name: Live smoke (ubuntu)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: requirements.txt

      - name: Install engine dependencies
        run: python -m pip install -r requirements.txt

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: tui_skeleton/package-lock.json

      - name: Install TUI dependencies
        working-directory: tui_skeleton
        run: npm ci

      - name: Phase 12 live smoke
        env:
          RAY_SCE_LOCAL_MODE: "1"
          BREADBOARD_SKIP_LOCAL_BIN_INSTALL: "1"
          BREADBOARD_INSTALL_QUIET: "1"
        run: bash scripts/phase12_live_smoke.sh

  python:
    name: Python (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: requirements.txt

      - name: Install dependencies
        run: python -m pip install -r requirements.txt

      - name: Install optional MCP dependency (for smokes)
        run: python -m pip install mcp

      - name: Verify exported CLI bridge contracts are up-to-date
        run: |
          python scripts/export_cli_bridge_contracts.py
          git diff --exit-code docs/contracts/cli_bridge

      - name: Targeted tests
        run: >
          python -m pytest -q
          tests/test_cli_bridge_contract_exports.py
          tests/test_policy_pack_enforcement.py
          tests/test_permission_rule_persistence.py
          tests/test_cli_bridge_checkpoint_commands.py
          tests/test_plugin_loader.py
          tests/test_skills_registry.py
          tests/test_mcp_manager.py

  python_smoke:
    name: Python smoke (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install minimal test dependencies
        run: python -m pip install pytest jsonschema

      - name: Contract schema smoke
        run: python -m pytest -q tests/test_cli_bridge_contract_exports.py
