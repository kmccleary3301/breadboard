name: Release engine bundles

on:
  workflow_dispatch:
    inputs:
      version:
        description: Engine version string (e.g. 0.2.0)
        required: true
        type: string
      release_tag:
        description: GitHub release tag (default: engine-v<version>)
        required: false
        type: string
      prerelease:
        description: Mark the release as prerelease
        required: false
        default: true
        type: boolean

jobs:
  create_release:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.resolve.outputs.tag }}
    steps:
      - id: resolve
        name: Resolve release tag
        shell: bash
        run: |
          set -euo pipefail
          if [ -n "${{ inputs.release_tag }}" ]; then
            echo "tag=${{ inputs.release_tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=engine-v${{ inputs.version }}" >> "$GITHUB_OUTPUT"
          fi

      - uses: actions/checkout@v4

      - name: Ensure release exists
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ steps.resolve.outputs.tag }}
          VERSION: ${{ inputs.version }}
          PRERELEASE: ${{ inputs.prerelease }}
        shell: bash
        run: |
          set -euo pipefail
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG already exists."
            exit 0
          fi
          flags=()
          if [ "$PRERELEASE" = "true" ]; then
            flags+=(--prerelease)
          fi
          gh release create "$TAG" \
            --title "BreadBoard engine $VERSION" \
            --notes "Automated engine bundle release." \
            "${flags[@]}"

  build_bundles:
    needs: create_release
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    env:
      VERSION: ${{ inputs.version }}
      TAG: ${{ needs.create_release.outputs.tag }}
      BASE_URL: https://github.com/${{ github.repository }}/releases/download/${{ needs.create_release.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install build deps
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt -r requirements_web.txt pyinstaller

      - name: Build engine bundle (onedir -> archive -> manifest)
        shell: bash
        run: |
          set -euo pipefail
          python scripts/build_local_engine_bundle.py \
            --version "$VERSION" \
            --out-root dist/engine_bundles \
            --clean \
            --base-url "$BASE_URL"

      - name: Smoke bundled engine (/health)
        shell: bash
        run: |
          set -euo pipefail
          PORT=19123
          export BREADBOARD_CLI_HOST=127.0.0.1
          export BREADBOARD_CLI_PORT="$PORT"

          shopt -s nullglob
          candidates=(dist/engine_bundles/build/"$VERSION"/*/dist/breadboard-engine*)
          if [ "${#candidates[@]}" -eq 0 ]; then
            echo "No onedir output found under dist/engine_bundles/build/$VERSION" >&2
            exit 2
          fi
          onedir="${candidates[0]}"
          exe=""
          if [ -f "$onedir/breadboard-engine" ]; then
            exe="$onedir/breadboard-engine"
          elif [ -f "$onedir/breadboard-engine.exe" ]; then
            exe="$onedir/breadboard-engine.exe"
          else
            echo "Unable to locate engine executable in $onedir" >&2
            ls -la "$onedir" || true
            exit 3
          fi
          chmod +x "$exe" || true
          "$exe" &
          pid="$!"
          trap 'kill "$pid" >/dev/null 2>&1 || true' EXIT
          sleep 3
          curl -fsS "http://127.0.0.1:${PORT}/health" >/dev/null

      - name: Rename manifest fragment
        shell: bash
        run: |
          set -euo pipefail
          cd dist/engine_bundles/dist
          mv manifest.json "manifest-${{ runner.os }}.json"

      - uses: actions/upload-artifact@v4
        with:
          name: engine-bundle-${{ runner.os }}
          path: dist/engine_bundles/dist/**
          if-no-files-found: error

  publish_release_assets:
    needs: [create_release, build_bundles]
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
      TAG: ${{ needs.create_release.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: actions/download-artifact@v4
        with:
          path: dist/collected

      - name: Merge manifest fragments
        shell: bash
        run: |
          set -euo pipefail
          shopt -s globstar nullglob
          fragments=(dist/collected/**/manifest-*.json)
          if [ "${#fragments[@]}" -eq 0 ]; then
            echo "No manifest fragments found." >&2
            exit 2
          fi
          python scripts/merge_engine_manifest.py --out dist/manifest.json "${fragments[@]}"

      - name: Validate manifest assets
        shell: bash
        run: |
          set -euo pipefail
          python scripts/validate_engine_manifest.py dist/manifest.json --asset-root dist/collected

      - name: Upload bundles + manifest to release
        shell: bash
        run: |
          set -euo pipefail
          shopt -s globstar nullglob
          assets=(dist/collected/**/breadboard-engine-*.tar.gz dist/collected/**/breadboard-engine-*.zip)
          if [ "${#assets[@]}" -eq 0 ]; then
            echo "No bundle archives found." >&2
            exit 2
          fi
          gh release upload "$TAG" dist/manifest.json "${assets[@]}" --clobber
